<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-0">Allowed Domains Management</h2>
        <p class="text-muted mb-0">Manage email domains allowed for user registration</p>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
        <i class="fas fa-plus me-2"></i>Add Domain
      </button>
    </div>
  </div>
</div>

<!-- Domains Table -->
<div class="card admin-card">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="fas fa-globe me-2"></i>
      Allowed Domains (<%= len(domains) %>)
    </h5>
  </div>
  <div class="card-body">
    <%= if (len(domains) == 0) { %>
      <div class="text-center py-5">
        <i class="fas fa-globe fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No domains configured</h5>
        <p class="text-muted">Add allowed email domains to restrict user registration.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
          <i class="fas fa-plus me-2"></i>Add First Domain
        </button>
      </div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Domain</th>
              <th>Description</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <%= for (domain) in domains { %>
              <tr>
                <td>
                  <strong><%= domain.Domain %></strong>
                </td>
                <td>
                  <%= if (domain.Description != "") { %>
                    <%= domain.Description %>
                  <% } else { %>
                    <span class="text-muted">No description</span>
                  <% } %>
                </td>
                <td>
                  <%= if (domain.IsActive) { %>
                    <span class="badge bg-success">Active</span>
                  <% } else { %>
                    <span class="badge bg-secondary">Inactive</span>
                  <% } %>
                </td>
                <td><%= domain.CreatedAt.Format("Jan 02, 2006") %></td>
                <td>
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="modal" data-bs-target="#editDomainModal"
                            data-domain-id="<%= domain.ID %>"
                            data-domain="<%= domain.Domain %>"
                            data-description="<%= domain.Description %>"
                            data-is-active="<%= domain.IsActive %>">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal" data-bs-target="#deleteDomainModal"
                            data-domain-id="<%= domain.ID %>"
                            data-domain="<%= domain.Domain %>">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<!-- Add Domain Modal -->
<div class="modal fade" id="addDomainModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="/admin/domains">
        <input type="hidden" name="authenticity_token" value="<%= authenticity_token %>" />
        <div class="modal-header">
          <h5 class="modal-title">Add Allowed Domain</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="domain" class="form-label">Domain <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="domain" name="domain"
                   placeholder="example.com" required>
            <div class="form-text">Enter the domain name (e.g., company.com)</div>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <input type="text" class="form-control" id="description" name="description"
                   placeholder="Company email domain">
            <div class="form-text">Optional description for this domain</div>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
            <label class="form-check-label" for="is_active">
              Active
            </label>
            <div class="form-text">Inactive domains will not allow new registrations</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Domain</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Domain Modal -->
<div class="modal fade" id="editDomainModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="" id="editDomainForm">
        <input type="hidden" name="_method" value="PUT">
        <input type="hidden" name="authenticity_token" value="<%= authenticity_token %>" />
        <div class="modal-header">
          <h5 class="modal-title">Edit Domain</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_domain" class="form-label">Domain <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="edit_domain" name="domain" required>
          </div>
          <div class="mb-3">
            <label for="edit_description" class="form-label">Description</label>
            <input type="text" class="form-control" id="edit_description" name="description">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
            <label class="form-check-label" for="edit_is_active">
              Active
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Domain</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Domain Modal -->
<div class="modal fade" id="deleteDomainModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="" id="deleteDomainForm">
        <input type="hidden" name="_method" value="DELETE">
        <input type="hidden" name="authenticity_token" value="<%= authenticity_token %>" />
        <div class="modal-header">
          <h5 class="modal-title">Delete Domain</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the domain <strong id="deleteDomainName"></strong>?</p>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            This action cannot be undone. Users with emails from this domain may no longer be able to register.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Domain</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Handle edit modal data population
document.getElementById('editDomainModal').addEventListener('show.bs.modal', function (event) {
  const button = event.relatedTarget;
  const domainId = button.getAttribute('data-domain-id');
  const domain = button.getAttribute('data-domain');
  const description = button.getAttribute('data-description');
  const isActive = button.getAttribute('data-is-active') === 'true';

  const form = document.getElementById('editDomainForm');
  form.action = `/admin/domains/${domainId}`;

  document.getElementById('edit_domain').value = domain;
  document.getElementById('edit_description').value = description;
  document.getElementById('edit_is_active').checked = isActive;
});

// Handle delete modal data population
document.getElementById('deleteDomainModal').addEventListener('show.bs.modal', function (event) {
  const button = event.relatedTarget;
  const domainId = button.getAttribute('data-domain-id');
  const domain = button.getAttribute('data-domain');

  const form = document.getElementById('deleteDomainForm');
  form.action = `/admin/domains/${domainId}`;

  document.getElementById('deleteDomainName').textContent = domain;
});
</script>