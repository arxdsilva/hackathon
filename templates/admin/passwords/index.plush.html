<div class="row">
  <div class="col-12">
    <div class="card admin-card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-key text-danger me-2"></i>Password Reset Management
        </h5>
      </div>
      <div class="card-body">
        <p class="text-muted mb-4">
          Reset passwords for users who have forgotten theirs or need administrative assistance.
        </p>

        <!-- Reset by User Search -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Reset Password for Specific User</h6>
          </div>
          <div class="card-body">
            <form class="row g-3">
              <div class="col-md-8">
                <label for="userSearch" class="form-label">Search User</label>
                <input type="text" class="form-control" id="userSearch" placeholder="Enter email or name" autocomplete="off">
                <div id="searchResults" class="mt-2" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                  <!-- Search results will be populated here -->
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-outline-primary me-2" id="searchBtn">
                  <i class="fas fa-search"></i> Search
                </button>
                <button type="button" class="btn btn-warning" id="resetBtn" disabled>
                  <i class="fas fa-key"></i> Force Reset Password
                </button>
              </div>
            </form>

            <div id="userResults" class="mt-3" style="display: none;">
              <div class="alert alert-info">
                <strong>Selected User:</strong> <span id="selectedUserName">No user selected</span> (<span id="selectedUserEmail"></span>)
                <br>
                <small class="text-muted">Click "Force Reset Password" to require this user to reset their password on next login.</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Reset Options -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Bulk Password Reset <span class="badge bg-secondary">Coming Soon</span></h6>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Warning:</strong> Bulk reset will force all selected users to change their passwords on next login.
            </div>

            <div class="row">
              <div class="col-md-6">
                <h6>Reset by Role</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="resetOwners">
                  <label class="form-check-label" for="resetOwners">
                    All Owners (<span class="text-primary">2 users</span>)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="resetHackers">
                  <label class="form-check-label" for="resetHackers">
                    All Hackers (<span class="text-success">15 users</span>)
                  </label>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <button type="button" class="btn btn-danger" id="bulkResetBtn">
                <i class="fas fa-exclamation-triangle me-1"></i>Execute Bulk Reset
              </button>
            </div>
          </div>
        </div>

        <!-- Password Policy -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Password Policy Settings</h6>
          </div>
          <div class="card-body">
            <form id="passwordPolicyForm">
              <input type="hidden" name="authenticity_token" value="<%= authenticity_token %>" />
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="passwordMinLength" class="form-label">Minimum Password Length</label>
                    <input type="number" class="form-control" id="passwordMinLength" name="password_min_length" value="<%= config.PasswordMinLength %>" min="6" max="32" required>
                    <div class="form-text">Minimum: 6 characters, Maximum: 32 characters</div>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="passwordRequireUppercase" name="password_require_uppercase" <%= if (config.PasswordRequireUppercase) { %>checked<% } %>>
                    <label class="form-check-label" for="passwordRequireUppercase">Require uppercase letters</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="passwordRequireNumbers" name="password_require_numbers" <%= if (config.PasswordRequireNumbers) { %>checked<% } %>>
                    <label class="form-check-label" for="passwordRequireNumbers">Require numbers</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="sessionTimeoutMinutes" class="form-label">Session Timeout (minutes)</label>
                    <input type="number" class="form-control" id="sessionTimeoutMinutes" name="session_timeout_minutes" value="<%= config.SessionTimeoutMinutes %>" min="15" max="1440">
                    <div class="form-text">How long before users are automatically logged out (15-1440 minutes)</div>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="passwordRequireSpecialChars" name="password_require_special_chars" <%= if (config.PasswordRequireSpecialChars) { %>checked<% } %>>
                    <label class="form-check-label" for="passwordRequireSpecialChars">Require special characters</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="twoFactorRequired" name="two_factor_required" <%= if (config.TwoFactorRequired) { %>checked<% } %>>
                    <label class="form-check-label" for="twoFactorRequired">Require two-factor authentication</label>
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-1"></i>Update Policy
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmResetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Password Reset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to reset the password for <strong id="confirmUser">selected user</strong>?</p>
        <div class="alert alert-info">
          <small>A temporary password will be generated and sent to their email address.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning">Reset Password</button>
      </div>
    </div>
  </div>
</div>

<script>
let selectedUserId = null;
let searchTimeout = null;

// Search functionality
document.getElementById('userSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    if (query.length < 2) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }
    
    // Debounce search
    searchTimeout = setTimeout(() => {
        performSearch(query);
    }, 300);
});

document.getElementById('searchBtn').addEventListener('click', function() {
    const query = document.getElementById('userSearch').value.trim();
    if (query.length >= 2) {
        performSearch(query);
    }
});

function performSearch(query) {
    fetch(`/admin/passwords/search?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displaySearchResults(data.users);
    })
    .catch(error => {
        console.error('Search error:', error);
        showAlert('Error searching users', 'danger');
    });
}

function displaySearchResults(users) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (users.length === 0) {
        resultsDiv.innerHTML = '<div class="p-2 text-muted">No users found</div>';
        resultsDiv.style.display = 'block';
        return;
    }
    
    let html = '';
    users.forEach(user => {
        html += `
            <div class="p-2 border-bottom user-result" data-user-id="${user.id}" data-user-name="${user.name}" data-user-email="${user.email}" style="cursor: pointer;">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <strong>${user.name}</strong><br>
                        <small class="text-muted">${user.email}</small>
                    </div>
                    <div>
                        <span class="badge bg-${user.role === 'owner' ? 'primary' : 'secondary'}">${user.role}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    
    // Add click handlers
    document.querySelectorAll('.user-result').forEach(result => {
        result.addEventListener('click', function() {
            selectUser(this.dataset.userId, this.dataset.userName, this.dataset.userEmail);
        });
    });
}

function selectUser(userId, name, email) {
    selectedUserId = userId;
    document.getElementById('selectedUserName').textContent = name;
    document.getElementById('selectedUserEmail').textContent = email;
    document.getElementById('userResults').style.display = 'block';
    document.getElementById('resetBtn').disabled = false;
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('userSearch').value = '';
}

// Force reset password
document.getElementById('resetBtn').addEventListener('click', function() {
    if (!selectedUserId) {
        showAlert('Please select a user first', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to force password reset for ${document.getElementById('selectedUserName').textContent}?`)) {
        forcePasswordReset(selectedUserId);
    }
});

function forcePasswordReset(userId) {
    const formData = new FormData();
    formData.append('user_id', userId);
    
    fetch('/admin/passwords/force-reset', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Reset selection
            selectedUserId = null;
            document.getElementById('selectedUserName').textContent = 'No user selected';
            document.getElementById('selectedUserEmail').textContent = '';
            document.getElementById('userResults').style.display = 'none';
            document.getElementById('resetBtn').disabled = true;
        } else {
            showAlert('Failed to force password reset', 'danger');
        }
    })
    .catch(error => {
        console.error('Reset error:', error);
        showAlert('Error forcing password reset', 'danger');
    });
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    const searchResults = document.getElementById('searchResults');
    const searchInput = document.getElementById('userSearch');
    
    if (!searchResults.contains(e.target) && e.target !== searchInput) {
        searchResults.style.display = 'none';
    }
});

// Password Policy Form Submission
document.getElementById('passwordPolicyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Convert checkboxes to "true"/"false" strings
    const checkboxes = ['password_require_uppercase', 'password_require_numbers', 'password_require_special_chars', 'two_factor_required'];
    checkboxes.forEach(name => {
        formData.set(name, document.getElementById(name.replace(/_/g, '')).checked ? 'true' : 'false');
    });
    
    fetch('/admin/config', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => {
        if (response.ok) {
            showAlert('Password policy updated successfully!', 'success');
        } else {
            throw new Error('Failed to update password policy');
        }
    })
    .catch(error => {
        console.error('Policy update error:', error);
        showAlert('Error updating password policy', 'danger');
    });
});
</script>